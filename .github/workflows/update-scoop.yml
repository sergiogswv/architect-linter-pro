name: Update Scoop Manifest

on:
  release:
    types: [published]

jobs:
  update-scoop:
    name: Update Scoop bucket manifest
    runs-on: ubuntu-22.04
    permissions:
      contents: read

    steps:
      - name: Compute SHA256 for Windows binary
        id: sha
        run: |
          TAG="${{ github.ref_name }}"
          URL="https://github.com/sergiogswv/architect-linter-pro/releases/download/${TAG}/architect-linter-pro-windows-x86_64.exe"
          SHA=$(curl -fsSL "$URL" | sha256sum | cut -d' ' -f1)
          echo "win_sha256=$SHA" >> "$GITHUB_OUTPUT"

      - name: Checkout Scoop bucket repo
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          repository: sergiogswv/scoop-architect-linter-pro
          token: ${{ secrets.TAP_REPO_TOKEN }}
          path: bucket

      - name: Update manifest version and hash
        run: |
          TAG="${{ github.ref_name }}"
          VERSION="${TAG#v}"
          MANIFEST="bucket/bucket/architect-linter-pro.json"

          # Update version field
          jq --arg v "$VERSION" '.version = $v' "$MANIFEST" > tmp.json
          mv tmp.json "$MANIFEST"

          # Update hash field (nested in architecture.64bit)
          jq --arg h "${{ steps.sha.outputs.win_sha256 }}" \
            '.architecture["64bit"].hash = $h' "$MANIFEST" > tmp.json
          mv tmp.json "$MANIFEST"

          # Update URL to use new version
          jq --arg v "$VERSION" \
            '.architecture["64bit"].url = "https://github.com/sergiogswv/architect-linter-pro/releases/download/v\($v)/architect-linter-pro-windows-x86_64.exe"' \
            "$MANIFEST" > tmp.json
          mv tmp.json "$MANIFEST"

          echo "Updated manifest:"
          cat "$MANIFEST"

      - name: Commit and push
        run: |
          cd bucket
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add bucket/architect-linter-pro.json
          git diff --staged --quiet && echo "No changes to commit" && exit 0
          git commit -m "chore: update architect-linter-pro to ${{ github.ref_name }}"
          git push
