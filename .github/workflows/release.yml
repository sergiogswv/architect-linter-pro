name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    name: Build ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            target: x86_64-unknown-linux-gnu
            artifact: architect-linter-pro-linux-x86_64
          - os: ubuntu-22.04
            target: aarch64-unknown-linux-gnu
            artifact: architect-linter-pro-linux-aarch64
            cross: true
          - os: macos-13
            target: x86_64-apple-darwin
            artifact: architect-linter-pro-macos-x86_64
          - os: macos-14
            target: aarch64-apple-darwin
            artifact: architect-linter-pro-macos-aarch64
          - os: windows-2022
            target: x86_64-pc-windows-msvc
            artifact: architect-linter-pro-windows-x86_64.exe

    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Install Rust
        uses: dtolnay/rust-toolchain@4f647fc679bcd3b11499ccb9c36cba5c9a43b9b  # stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache Cargo registry
        uses: actions/cache@3624ceb22c1b0b1cc9087a2c4e84ee0c7d7ae01e  # v4.1.1
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-${{ matrix.target }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.target }}-cargo-

      - name: Install cross (ARM Linux only)
        if: matrix.cross
        run: cargo install cross --version 0.2.5

      - name: Build (native)
        if: ${{ !matrix.cross }}
        run: cargo build --release --target ${{ matrix.target }}

      - name: Build (cross-compiled)
        if: ${{ matrix.cross }}
        run: cross build --release --target ${{ matrix.target }}

      - name: Prepare binary (Unix)
        if: runner.os != 'Windows'
        run: |
          cp target/${{ matrix.target }}/release/architect-linter-pro \
             ${{ matrix.artifact }}
          chmod +x ${{ matrix.artifact }}

      - name: Prepare binary (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Copy-Item "target\${{ matrix.target }}\release\architect-linter-pro.exe" `
                    "${{ matrix.artifact }}"

      - name: Upload artifact
        uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08  # v4.6.0
        with:
          name: ${{ matrix.artifact }}
          path: ${{ matrix.artifact }}

  release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    steps:
      - name: Download all build artifacts
        uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e  # v4.2.1
        with:
          path: artifacts/
          merge-multiple: true

      - name: Generate SHA256 checksums
        run: |
          cd artifacts
          sha256sum * > SHA256SUMS.txt
          echo "=== Checksums ==="
          cat SHA256SUMS.txt

      - name: Generate per-binary .sha256 sidecar files
        run: |
          cd artifacts
          for f in architect-linter-pro-*; do
            [ -f "$f" ] && sha256sum "$f" | cut -d' ' -f1 > "${f}.sha256"
          done
          ls *.sha256

      - name: Create GitHub Release
        uses: softprops/action-gh-release@da05d552573ad5aba039eaac05058a918a7bf631  # v2.2.1
        with:
          files: |
            artifacts/*
          generate_release_notes: true
          fail_on_unmatched_files: true
